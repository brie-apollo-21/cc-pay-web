<script>
    import { onMount } from 'svelte';
    import { userState, clearUserState, refreshBalance, completePayment, refreshHistory } from '$lib/user.svelte';
    import QrScanner from 'qr-scanner';
    import { writable } from 'svelte/store';
    import thousandsFormat from '$lib/thousandsFormat';
    import Transaction from '$lib/Transaction.svelte';
    
    const merchant = writable(undefined);
    const price = writable(undefined);
    const scanning = writable(false);
    
    onMount(() => {
        if(userState.id_token == undefined && localStorage.getItem("user") != null) {
            const user = JSON.parse(localStorage.getItem("user"))
            userState.id_token = user.id_token
            userState.name = user.name
            userState.email = user.email
            userState.picture = user.picture
            userState.balance = user.balance
            refreshBalance()
            refreshHistory()
        }
        if(userState.id_token == undefined && window.location.href !== window.location.origin+"/login") {
            // alert(JSON.stringify(userState))
            window.location.replace(window.location.origin+"/login")
        }

        const qrScanner = new QrScanner(
            document.getElementById("qr"),
            (result) => {
                console.log('decoded qr code:', result);
                if($merchant == undefined) {
                    merchant.set(result)
                }
            },
        );

        // document.getElementById("scanBtn").onclick = () => {
        //     qrScanner.start()
        //     document.getElementById("qr").classList.remove("h-0")
        // }
        scanning.subscribe((value) => {
            if(value == false) {
                qrScanner.stop()
                document.getElementById("qr").classList.add("h-0")
            }
            if(value == true) {
                qrScanner.start()
                document.getElementById("qr").classList.remove("h-0")
            }
        })
        document.getElementById("logoutBtn").onclick = () => {
            setTimeout(() => {
                clearUserState()
                window.location.replace(window.location.origin+"/login")
            }, 150)
        }

        // userState.paymentCompleted.subscribe((value) => {
        //     if(value == true) {
        //         document.getElementById('payBtn').classList.remove("animate-pulse")
        //     }
        // })

        // document.getElementById("name").innerHTML = sessionStorage.getItem("name")
        // document.getElementById("name").innerHTML = sessionStorage.getItem("name")
    })
</script>

    <!-- svelte-ignore a11y_no_static_element_interactions -->
    <div class="flex flex-row items-center rounded-full p-2 justify-between drop-shadow-sm drop-shadow-aztec-gold bg-maize">
        <div class="flex flex-row items-center m-0 p-0">
            <div class="flex items-center justify-center rounded-full aspect-square w-14 bg-aztec-gold/50"><i class="fa-solid fa-wallet text-lg"></i></div>
            <div class="flex flex-col h-full align-middle ml-2">
                <span id="balance" class="font-bold leading-5">{userState.balance}</span>
                <span id="name" class="leading-5">{userState.name}</span>
            </div>
        </div>
        <!-- svelte-ignore a11y_click_events_have_key_events -->
        <div onclick={() => {scanning.set(true)}} id="scanBtn" class="flex flex-col items-center justify-center rounded-full aspect-square w-14 group" style="background-color: #c5934a80;"><i class="fa-solid fa-qrcode text-lg group-active:opacity-50 duration-200"></i><span class="text-xs">Scan</span></div>
    </div>
    <!-- svelte-ignore a11y_media_has_caption -->
    <video id="qr" class="aspect-square object-cover my-4 rounded-md drop-shadow-sm h-0"></video>

<div class="flex flex-col h-full items-center gap-4">
    <!-- svelte-ignore a11y_no_static_element_interactions -->
    {#if $scanning == false}
    
    <span id="balance" class="font-bold">Transaction History</span>
    <div id="history" class="flex flex-col overflow-scroll max-h-1/2 w-full m-0 px-2 items-center">
        {#each userState.history as item (item.timestamp)}
        
        <Transaction label={item.merchant_name} amount={item.amount} timestamp={item.timestamp} />

        {/each}
    </div>

    {:else}

    <!-- svelte-ignore a11y_click_events_have_key_events -->
    <!-- svelte-ignore a11y_no_static_element_interactions -->
    <i onclick={() => {
        setTimeout(() => {
            merchant.set(undefined);
            price.set(undefined);
            scanning.set(false)
        }, 150)
    }} class="active:opacity-50 active:underline duration-200">cancel</i>

    {/if}
    {#if $merchant != undefined}

    <input id="price" onfocusin={() => {document.getElementById('price').value = ($price == undefined ? "" : $price)}} oninput={() => {price.set(document.getElementById('price').value); console.log($price)}} onfocusout={() => {document.getElementById('price').value = "Rp"+thousandsFormat($price)}} type="text" placeholder="Rp10.000" class="border border-aztec-gold w-1/2 py-2 px-4 rounded-md text-center bg-maize">
    <!-- svelte-ignore a11y_click_events_have_key_events -->
    <!-- svelte-ignore a11y_no_static_element_interactions -->
    <div id="payBtn" onclick={() => {
        completePayment($merchant, $price).then((response) => {
            document.getElementById('payBtn').classList.remove("animate-pulse")
            price.set(undefined)
            merchant.set(undefined)
            scanning.set(false)
            refreshBalance()
            refreshHistory()
            if(response == "Payment completed") {
                alert("Payment completed!")
            }
        });
        document.getElementById('payBtn').classList.add("animate-pulse");
    }} class="flex justify-center w-fit py-2 px-4 rounded-full drop-shadow-sm drop-shadow-aztec-gold bg-maize group"><span class="group-active:opacity-50 duration-200">Pay <i>{$merchant}</i></span></div>

    {/if}

    <i id="logoutBtn" class="opacity-50 active:opacity-25 active:underline duration-200 absolute bottom-10">logout</i>
</div>